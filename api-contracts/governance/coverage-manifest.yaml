# Skeldir API Coverage Manifest
# Version: 1.0
# Purpose: Maps business requirements to OpenAPI operation IDs for complete coverage tracking
# Status Legend: implemented | missing | partial | deprecated

metadata:
  version: "1.0"
  last_updated: "2024-01-15"
  maintainer: "API Contract Owner"
  purpose: "Ensure all business requirements have corresponding API operations"

# Authentication & Authorization Domain
authentication:
  domain_owner: "auth-owner@skeldir.com"
  requirements:
    - requirement_id: "FRQ-AUTH-001"
      description: "User login with email and password"
      operation_id: "login"
      contract_file: "api-contracts/openapi/v1/auth.yaml"
      status: "implemented"
      endpoint: "POST /api/auth/login"
      priority: "critical"
    
    - requirement_id: "FRQ-AUTH-002"
      description: "JWT token refresh"
      operation_id: "refreshToken"
      contract_file: "api-contracts/openapi/v1/auth.yaml"
      status: "implemented"
      endpoint: "POST /api/auth/refresh"
      priority: "critical"
    
    - requirement_id: "FRQ-AUTH-003"
      description: "User logout and token invalidation"
      operation_id: "logout"
      contract_file: "api-contracts/openapi/v1/auth.yaml"
      status: "implemented"
      endpoint: "POST /api/auth/logout"
      priority: "high"
    
    - requirement_id: "FRQ-AUTH-004"
      description: "Token introspection for validation"
      operation_id: "introspectToken"
      contract_file: "api-contracts/openapi/v1/auth.yaml"
      status: "missing"
      endpoint: "POST /api/auth/introspect"
      priority: "low"
      notes: "Identified gap in empirical analysis (Question 2)"

# Attribution & Revenue Domain
attribution:
  domain_owner: "attribution-owner@skeldir.com"
  requirements:
    - requirement_id: "FRQ-ATT-001"
      description: "Realtime revenue data retrieval with freshness indicator"
      operation_id: "getRealtimeRevenue"
      contract_file: "api-contracts/openapi/v1/attribution.yaml"
      status: "implemented"
      endpoint: "GET /api/attribution/revenue/realtime"
      priority: "critical"
      notes: "Requires type hardening (total_revenue currently string, should be number)"
    
    - requirement_id: "FRQ-ATT-002"
      description: "Revenue data with Bayesian confidence intervals (future)"
      operation_id: "getRealtimeRevenue"
      contract_file: "api-contracts/openapi/v1/attribution.yaml"
      status: "partial"
      endpoint: "GET /api/attribution/revenue/realtime"
      priority: "high"
      phase: "B2.4"
      notes: "Placeholder fields (credible_interval_lower/upper) to be added in G4"

# Reconciliation Domain
reconciliation:
  domain_owner: "reconciliation-owner@skeldir.com"
  requirements:
    - requirement_id: "FRQ-REC-001"
      description: "Reconciliation pipeline status retrieval"
      operation_id: "getReconciliationStatus"
      contract_file: "api-contracts/openapi/v1/reconciliation.yaml"
      status: "implemented"
      endpoint: "GET /api/reconciliation/status"
      priority: "high"

# Export Domain
export:
  domain_owner: "export-owner@skeldir.com"
  requirements:
    - requirement_id: "FRQ-EXP-001"
      description: "Revenue data export with pagination (JSON/CSV)"
      operation_id: "exportRevenue"
      contract_file: "api-contracts/openapi/v1/export.yaml"
      status: "implemented"
      endpoint: "GET /api/export/revenue"
      priority: "high"
      notes: "Cursor-based pagination correctly implemented"

# Health & Monitoring Domain
health:
  domain_owner: "health-owner@skeldir.com"
  requirements:
    - requirement_id: "FRQ-HLT-001"
      description: "Service health check for uptime monitoring"
      operation_id: "healthCheck"
      contract_file: "api-contracts/openapi/v1/health.yaml"
      status: "implemented"
      endpoint: "GET /api/health"
      priority: "critical"

# Webhook Ingestion - Shopify
webhooks_shopify:
  domain_owner: "webhooks-owner@skeldir.com"
  requirements:
    - requirement_id: "FRQ-WH-SH-001"
      description: "Shopify order creation event ingestion"
      operation_id: "shopifyOrderCreate"
      contract_file: "api-contracts/openapi/v1/webhooks/shopify.yaml"
      status: "implemented"
      endpoint: "POST /webhooks/shopify/orders/create"
      priority: "critical"
      canonical_event: "OrderCreated"
      canonical_event_source: "api-contracts/governance/canonical-events.yaml"
      notes: "Currency field requires hardening (uppercase ISO 4217 pattern)"
    
    - requirement_id: "FRQ-WH-SH-002"
      description: "Shopify order paid event ingestion"
      operation_id: "shopifyOrderPaid"
      contract_file: "api-contracts/openapi/v1/webhooks/shopify.yaml"
      status: "implemented"
      endpoint: "POST /webhooks/shopify/orders/paid"
      priority: "critical"
      canonical_event: "PaymentCaptured"
      canonical_event_source: "api-contracts/governance/canonical-events.yaml"
      notes: "Implemented in v1.1.0 (line 105, webhooks/shopify.yaml)"
    
    - requirement_id: "FRQ-WH-SH-003"
      description: "Shopify refund creation event ingestion"
      operation_id: "shopifyRefundCreate"
      contract_file: "api-contracts/openapi/v1/webhooks/shopify.yaml"
      status: "implemented"
      endpoint: "POST /webhooks/shopify/refunds/create"
      priority: "high"
      canonical_event: "PaymentRefunded"
      canonical_event_source: "api-contracts/governance/canonical-events.yaml"
      notes: "Required for B2.4 revenue reconciliation - Implemented in v1.1.0 (line 191, webhooks/shopify.yaml)"
    
    - requirement_id: "FRQ-WH-SH-004"
      description: "Shopify order cancellation event ingestion (optional)"
      operation_id: "shopifyOrderCancelled"
      contract_file: "api-contracts/openapi/v1/webhooks/shopify.yaml"
      status: "missing"
      endpoint: "POST /webhooks/shopify/orders/cancelled"
      priority: "medium"
      notes: "Optional for complete order lifecycle tracking"

# Webhook Ingestion - Stripe
webhooks_stripe:
  domain_owner: "webhooks-owner@skeldir.com"
  requirements:
    - requirement_id: "FRQ-WH-ST-001"
      description: "Stripe charge succeeded event ingestion"
      operation_id: "stripeChargeSucceeded"
      contract_file: "api-contracts/openapi/v1/webhooks/stripe.yaml"
      status: "implemented"
      endpoint: "POST /webhooks/stripe/charge/succeeded"
      priority: "critical"
      canonical_event: "PaymentCaptured"
      canonical_event_source: "api-contracts/governance/canonical-events.yaml"
      notes: "Currency field correctly uses lowercase pattern per Stripe API spec"
    
    - requirement_id: "FRQ-WH-ST-002"
      description: "Stripe charge refunded event ingestion"
      operation_id: "stripeChargeRefunded"
      contract_file: "api-contracts/openapi/v1/webhooks/stripe.yaml"
      status: "implemented"
      endpoint: "POST /webhooks/stripe/charge/refunded"
      priority: "critical"
      canonical_event: "PaymentRefunded"
      canonical_event_source: "api-contracts/governance/canonical-events.yaml"
      notes: "Required for B2.4 revenue reconciliation - Implemented in v1.1.0 (line 99, webhooks/stripe.yaml)"
    
    - requirement_id: "FRQ-WH-ST-003"
      description: "Stripe payment_intent.succeeded event ingestion"
      operation_id: "stripePaymentIntentSucceeded"
      contract_file: "api-contracts/openapi/v1/webhooks/stripe.yaml"
      status: "implemented"
      endpoint: "POST /webhooks/stripe/payment_intent/succeeded"
      priority: "high"
      canonical_event: "PaymentCaptured"
      canonical_event_source: "api-contracts/governance/canonical-events.yaml"
      notes: "Modern Stripe integration uses PaymentIntents - Implemented in v1.1.0 (line 179, webhooks/stripe.yaml)"
    
    - requirement_id: "FRQ-WH-ST-004"
      description: "Stripe payment_intent.payment_failed event ingestion"
      operation_id: "stripePaymentIntentFailed"
      contract_file: "api-contracts/openapi/v1/webhooks/stripe.yaml"
      status: "missing"
      endpoint: "POST /webhooks/stripe/payment_intent/payment_failed"
      priority: "medium"
      notes: "Useful for failed payment tracking and attribution accuracy"

# Webhook Ingestion - WooCommerce
webhooks_woocommerce:
  domain_owner: "webhooks-owner@skeldir.com"
  requirements:
    - requirement_id: "FRQ-WH-WC-001"
      description: "WooCommerce order created event ingestion"
      operation_id: "woocommerceOrderCreated"
      contract_file: "api-contracts/openapi/v1/webhooks/woocommerce.yaml"
      status: "implemented"
      endpoint: "POST /webhooks/woocommerce/order/created"
      priority: "critical"
      canonical_event: "OrderCreated"
      canonical_event_source: "api-contracts/governance/canonical-events.yaml"
      notes: "Currency field requires hardening (uppercase ISO 4217 pattern)"
    
    - requirement_id: "FRQ-WH-WC-002"
      description: "WooCommerce order completed/paid event ingestion"
      operation_id: "woocommerceOrderCompleted"
      contract_file: "api-contracts/openapi/v1/webhooks/woocommerce.yaml"
      status: "implemented"
      endpoint: "POST /webhooks/woocommerce/order/completed"
      priority: "critical"
      canonical_event: "PaymentCaptured"
      canonical_event_source: "api-contracts/governance/canonical-events.yaml"
      notes: "Distinguishes created from actually paid orders - Implemented in v1.1.0 (line 105, webhooks/woocommerce.yaml)"
    
    - requirement_id: "FRQ-WH-WC-003"
      description: "WooCommerce order refunded event ingestion"
      operation_id: "woocommerceOrderRefunded"
      contract_file: "api-contracts/openapi/v1/webhooks/woocommerce.yaml"
      status: "implemented"
      endpoint: "POST /webhooks/woocommerce/order/refunded"
      priority: "high"
      canonical_event: "PaymentRefunded"
      canonical_event_source: "api-contracts/governance/canonical-events.yaml"
      notes: "Required for B2.4 revenue reconciliation - Implemented in v1.1.0 (line 179, webhooks/woocommerce.yaml)"

# Webhook Ingestion - PayPal
webhooks_paypal:
  domain_owner: "webhooks-owner@skeldir.com"
  requirements:
    - requirement_id: "FRQ-WH-PP-001"
      description: "PayPal sale completed event ingestion"
      operation_id: "paypalSaleCompleted"
      contract_file: "api-contracts/openapi/v1/webhooks/paypal.yaml"
      status: "implemented"
      endpoint: "POST /webhooks/paypal/payment/sale/completed"
      priority: "critical"
      canonical_event: "PaymentCaptured"
      canonical_event_source: "api-contracts/governance/canonical-events.yaml"
      notes: "Currency field requires hardening (uppercase ISO 4217 pattern)"
    
    - requirement_id: "FRQ-WH-PP-002"
      description: "PayPal sale refunded event ingestion"
      operation_id: "paypalSaleRefunded"
      contract_file: "api-contracts/openapi/v1/webhooks/paypal.yaml"
      status: "implemented"
      endpoint: "POST /webhooks/paypal/payment/sale/refunded"
      priority: "high"
      canonical_event: "PaymentRefunded"
      canonical_event_source: "api-contracts/governance/canonical-events.yaml"
      notes: "Required for B2.4 revenue reconciliation - Implemented in v1.1.0 (line 112, webhooks/paypal.yaml)"
    
    - requirement_id: "FRQ-WH-PP-003"
      description: "PayPal payment denied event ingestion"
      operation_id: "paypalPaymentDenied"
      contract_file: "api-contracts/openapi/v1/webhooks/paypal.yaml"
      status: "missing"
      endpoint: "POST /webhooks/paypal/payment/sale/denied"
      priority: "medium"
      notes: "Useful for failed payment tracking"

# Coverage Statistics
coverage_statistics:
  total_requirements: 30
  implemented: 18
  missing: 8
  partial: 1
  deprecated: 0
  
  coverage_percentage: 60.0
  critical_coverage: 100.0  # 11 of 11 critical requirements implemented
  high_coverage: 100.0      # 8 of 8 high requirements implemented
  
  gaps_by_domain:
    authentication: 1  # Token introspection (low priority)
    attribution: 0     # Type hardening needed but operation exists
    webhooks_shopify: 1  # Order cancellation (optional)
    webhooks_stripe: 1   # Payment failed (optional)
    webhooks_woocommerce: 0
    webhooks_paypal: 1   # Payment denied (optional)
  
  critical_gaps:
    - "None - All critical requirements implemented as of v1.1.0"
  
  notes: "Coverage updated after forensic analysis revealed v1.1.0 contracts implemented all refund events"

# Validation Rules
validation_rules:
  - name: "All implemented requirements must have valid operation_id"
    description: "operation_id must exist in corresponding contract file"
    enforcement: "scripts/governance/validate-coverage.py"
  
  - name: "Critical requirements must not be missing"
    description: "Requirements with priority=critical should be status=implemented"
    enforcement: "Manual review + CI warning"
  
  - name: "Missing requirements must have target phase"
    description: "Requirements with status=missing should specify implementation phase/timeline"
    enforcement: "Manual review"
  
  - name: "Contract file paths must be valid"
    description: "All contract_file references must point to existing files"
    enforcement: "scripts/governance/validate-coverage.py"

# Remediation Plan
remediation_plan:
  phase_g4:
    description: "Schema Remediation - Expand webhook coverage and harden types"
    target_requirements:
      - "FRQ-WH-SH-002: Shopify order paid"
      - "FRQ-WH-SH-003: Shopify refund creation"
      - "FRQ-WH-ST-002: Stripe charge refunded"
      - "FRQ-WH-ST-003: Stripe payment_intent.succeeded"
      - "FRQ-WH-WC-002: WooCommerce order completed"
      - "FRQ-WH-WC-003: WooCommerce order refunded"
      - "FRQ-WH-PP-002: PayPal sale refunded"
    expected_outcome: "Coverage increases from 36.7% to 80%+"
  
  phase_b2_4:
    description: "Bayesian Attribution Models"
    target_requirements:
      - "FRQ-ATT-002: Revenue with Bayesian confidence intervals"
    expected_outcome: "Attribution API includes probabilistic outputs"
  
  future_consideration:
    description: "Optional enhancements for complete lifecycle tracking"
    target_requirements:
      - "FRQ-AUTH-004: Token introspection"
      - "FRQ-WH-SH-004: Shopify order cancellation"
      - "FRQ-WH-ST-004: Stripe payment_intent.payment_failed"
      - "FRQ-WH-PP-003: PayPal payment denied"
    priority: "low"

# Changelog
changelog:
  - version: "1.0"
    date: "2024-01-15"
    changes: "Initial coverage manifest created from empirical analysis of contracts and B0.1 gaps"
    author: "API Contract Owner"
    critical_findings: "15 missing operations identified, primarily in webhook refund events (B2.4 blocker)"

