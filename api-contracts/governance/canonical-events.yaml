# Skeldir Canonical Event Taxonomy & Revenue State Machine
# Version: 1.0.0
# Purpose: Provider-agnostic canonical event taxonomy serving as "north star" for coverage and mapping
# Source: Coverage & Integration Mapping Governance Specification (Phase C0)
# Last Updated: 2024-01-15

metadata:
  version: "1.0.0"
  last_updated: "2024-01-15"
  maintainer: "API Contract Owner"
  purpose: "Define canonical revenue events and state machine for all provider integrations"
  schema_source: "db/schema/canonical_schema.yaml"
  ledger_table: "revenue_ledger"

# ============================================================================
# CANONICAL EVENTS
# ============================================================================
# Provider-agnostic business events that map to internal ledger state transitions

canonical_events:
  PaymentCaptured:
    description: "Payment moved from authorized/pending to captured state"
    business_meaning: "Revenue is now recognized and counted toward attribution"
    category: "payment_capture"
    ledger_impact:
      table: "revenue_ledger"
      state_transition:
        from: "authorized"
        to: "captured"
      fields_affected:
        - "transaction_id"
        - "amount_cents"
        - "currency"
        - "state"
        - "previous_state"
        - "verification_source"
        - "verification_timestamp"
    idempotency_key: "transaction_id"
    idempotent: true
    required_for_phases: ["B2.2", "B2.4"]
  
  PaymentRefunded:
    description: "Previously captured payment is reversed (full or partial)"
    business_meaning: "Revenue is removed from attribution; affects historical reporting"
    category: "refund"
    ledger_impact:
      table: "revenue_ledger"
      state_transition:
        from: "captured"
        to: "refunded"
      fields_affected:
        - "transaction_id"
        - "amount_cents"
        - "state"
        - "previous_state"
        - "verification_source"
        - "verification_timestamp"
    idempotency_key: "transaction_id"
    idempotent: true
    required_for_phases: ["B2.4"]
  
  OrderCreated:
    description: "Order container created (no payment yet)"
    business_meaning: "Establishes order identity for future payment linkage"
    category: "order_state_change"
    ledger_impact:
      table: "revenue_ledger"
      state_transition:
        from: null
        to: "authorized"
      fields_affected:
        - "order_id"
        - "transaction_id"
        - "amount_cents"
        - "currency"
        - "state"
        - "verification_source"
        - "verification_timestamp"
    idempotency_key: "order_id"
    idempotent: true
    required_for_phases: ["B2.2"]
  
  PaymentDisputed:
    description: "Payment disputed by customer (chargeback)"
    business_meaning: "Revenue is reversed due to customer dispute; affects attribution and reporting"
    category: "revenue_state_transition"
    ledger_impact:
      table: "revenue_ledger"
      state_transition:
        from: "captured"
        to: "chargeback"
      fields_affected:
        - "transaction_id"
        - "state"
        - "previous_state"
        - "verification_source"
        - "verification_timestamp"
    idempotency_key: "transaction_id"
    idempotent: true
    required_for_phases: ["B2.4"]
    notes: "Future implementation - not currently required"

# ============================================================================
# REVENUE STATE MACHINE
# ============================================================================
# Defines allowed states and transitions for revenue_ledger.state field

revenue_state_machine:
  schema_source: "db/schema/canonical_schema.yaml:398"
  table: "revenue_ledger"
  state_column: "state"
  
  states:
    - name: "authorized"
      description: "Payment authorized but not yet captured"
      terminal: false
      next_states: ["captured"]
      business_meaning: "Order created, payment method authorized, awaiting capture"
    
    - name: "captured"
      description: "Payment successfully captured; revenue recognized"
      terminal: false
      next_states: ["refunded", "chargeback"]
      business_meaning: "Revenue is recognized and counted in attribution"
    
    - name: "refunded"
      description: "Payment refunded; revenue reversed"
      terminal: true
      next_states: []
      business_meaning: "Revenue removed from attribution; customer received refund"
    
    - name: "chargeback"
      description: "Payment disputed by customer"
      terminal: true
      next_states: []
      business_meaning: "Revenue reversed due to dispute; affects merchant account"
  
  transitions:
    - from: null
      to: "authorized"
      triggered_by: ["OrderCreated"]
      description: "Initial order creation with payment authorization"
      required: true
    
    - from: "authorized"
      to: "captured"
      triggered_by: ["PaymentCaptured"]
      description: "Payment successfully captured from authorized state"
      required: true
    
    - from: "captured"
      to: "refunded"
      triggered_by: ["PaymentRefunded"]
      description: "Payment refunded after successful capture"
      required: true
    
    - from: "captured"
      to: "chargeback"
      triggered_by: ["PaymentDisputed"]
      description: "Payment disputed by customer (chargeback)"
      required: false
      notes: "Future implementation"

# ============================================================================
# BUSINESS EVENT CATEGORIES
# ============================================================================
# Four non-negotiable categories for revenue attribution

business_event_categories:
  payment_capture:
    description: "Events that move revenue from potential to captured"
    canonical_events: ["PaymentCaptured"]
    provider_examples:
      - "Shopify: orders/paid"
      - "Stripe: charge.succeeded, payment_intent.succeeded"
      - "PayPal: PAYMENT.SALE.COMPLETED"
      - "WooCommerce: order/completed"
    critical: true
  
  refund:
    description: "Events that reverse revenue and affect attribution"
    canonical_events: ["PaymentRefunded"]
    provider_examples:
      - "Shopify: refunds/create"
      - "Stripe: charge.refunded"
      - "PayPal: PAYMENT.SALE.REFUNDED"
      - "WooCommerce: order/refunded"
    critical: true
  
  order_state_change:
    description: "Events that establish and mutate order containers"
    canonical_events: ["OrderCreated"]
    provider_examples:
      - "Shopify: orders/create, orders/updated"
      - "Stripe: N/A (uses payment objects directly)"
      - "PayPal: N/A (uses transaction objects directly)"
      - "WooCommerce: order/created"
    critical: true
  
  revenue_state_transition:
    description: "Internal ledger state transitions"
    canonical_events: ["PaymentDisputed"]
    provider_examples:
      - "Stripe: charge.dispute.created"
      - "PayPal: CUSTOMER.DISPUTE.CREATED"
    critical: false
    notes: "Future implementation for chargeback handling"

# ============================================================================
# PROVIDER COVERAGE MATRIX
# ============================================================================
# Maps canonical events to provider-specific events for all supported providers

provider_coverage_matrix:
  PaymentCaptured:
    - provider: "Stripe"
      provider_event: "charge.succeeded"
      delivery: "webhook"
      required: true
      priority: "critical"
      notes: "Legacy Charges API"
      contract_file: "api-contracts/openapi/v1/webhooks/stripe.yaml"
      operation_id: "stripeChargeSucceeded"
    
    - provider: "Stripe"
      provider_event: "payment_intent.succeeded"
      delivery: "webhook"
      required: true
      priority: "critical"
      notes: "Modern Payment Intents API (recommended)"
      contract_file: "api-contracts/openapi/v1/webhooks/stripe.yaml"
      operation_id: "stripePaymentIntentSucceeded"
    
    - provider: "Shopify"
      provider_event: "orders/paid"
      delivery: "webhook"
      required: true
      priority: "critical"
      notes: "Confirms payment received for order"
      contract_file: "api-contracts/openapi/v1/webhooks/shopify.yaml"
      operation_id: "shopifyOrderPaid"
    
    - provider: "PayPal"
      provider_event: "PAYMENT.SALE.COMPLETED"
      delivery: "webhook"
      required: true
      priority: "critical"
      notes: "Sale completed successfully"
      contract_file: "api-contracts/openapi/v1/webhooks/paypal.yaml"
      operation_id: "paypalSaleCompleted"
    
    - provider: "WooCommerce"
      provider_event: "order/completed"
      delivery: "webhook"
      required: true
      priority: "critical"
      notes: "Order status changed to completed (payment received)"
      contract_file: "api-contracts/openapi/v1/webhooks/woocommerce.yaml"
      operation_id: "woocommerceOrderCompleted"
  
  PaymentRefunded:
    - provider: "Stripe"
      provider_event: "charge.refunded"
      delivery: "webhook"
      required: true
      priority: "critical"
      notes: "Charge refunded (full or partial)"
      contract_file: "api-contracts/openapi/v1/webhooks/stripe.yaml"
      operation_id: "stripeChargeRefunded"
    
    - provider: "Shopify"
      provider_event: "refunds/create"
      delivery: "webhook"
      required: true
      priority: "critical"
      notes: "Refund created for order"
      contract_file: "api-contracts/openapi/v1/webhooks/shopify.yaml"
      operation_id: "shopifyRefundCreate"
    
    - provider: "PayPal"
      provider_event: "PAYMENT.SALE.REFUNDED"
      delivery: "webhook"
      required: true
      priority: "critical"
      notes: "Sale refunded"
      contract_file: "api-contracts/openapi/v1/webhooks/paypal.yaml"
      operation_id: "paypalSaleRefunded"
    
    - provider: "WooCommerce"
      provider_event: "order/refunded"
      delivery: "webhook"
      required: true
      priority: "critical"
      notes: "Order refunded"
      contract_file: "api-contracts/openapi/v1/webhooks/woocommerce.yaml"
      operation_id: "woocommerceOrderRefunded"
  
  OrderCreated:
    - provider: "Shopify"
      provider_event: "orders/create"
      delivery: "webhook"
      required: true
      priority: "high"
      notes: "Order created (may not be paid yet)"
      contract_file: "api-contracts/openapi/v1/webhooks/shopify.yaml"
      operation_id: "shopifyOrderCreate"
    
    - provider: "WooCommerce"
      provider_event: "order/created"
      delivery: "webhook"
      required: true
      priority: "high"
      notes: "Order created (may not be paid yet)"
      contract_file: "api-contracts/openapi/v1/webhooks/woocommerce.yaml"
      operation_id: "woocommerceOrderCreated"
    
    - provider: "Stripe"
      provider_event: null
      delivery: "N/A"
      required: false
      priority: "low"
      notes: "Stripe uses payment objects directly; no separate order concept"
      mitigation: "PaymentCaptured events serve as order creation for Stripe"
    
    - provider: "PayPal"
      provider_event: null
      delivery: "N/A"
      required: false
      priority: "low"
      notes: "PayPal uses transaction objects directly; no separate order concept"
      mitigation: "PaymentCaptured events serve as order creation for PayPal"
  
  PaymentDisputed:
    - provider: "Stripe"
      provider_event: "charge.dispute.created"
      delivery: "webhook"
      required: false
      priority: "medium"
      notes: "Future implementation for chargeback handling"
    
    - provider: "PayPal"
      provider_event: "CUSTOMER.DISPUTE.CREATED"
      delivery: "webhook"
      required: false
      priority: "medium"
      notes: "Future implementation for chargeback handling"
    
    - provider: "Shopify"
      provider_event: null
      delivery: "N/A"
      required: false
      priority: "low"
      notes: "Shopify handles disputes through payment processors"
      mitigation: "Monitor processor disputes (Stripe, PayPal)"
    
    - provider: "WooCommerce"
      provider_event: null
      delivery: "N/A"
      required: false
      priority: "low"
      notes: "WooCommerce handles disputes through payment processors"
      mitigation: "Monitor processor disputes (Stripe, PayPal)"

# ============================================================================
# VALIDATION RULES
# ============================================================================

validation_rules:
  category_completeness:
    description: "All four business categories must have at least one canonical event"
    severity: "BLOCKING"
    categories_required: ["payment_capture", "refund", "order_state_change", "revenue_state_transition"]
  
  state_machine_completeness:
    description: "Every ledger state must have at least one canonical event that transitions to it"
    severity: "BLOCKING"
    ledger_states: ["authorized", "captured", "refunded", "chargeback"]
  
  transition_uniqueness:
    description: "No two canonical events can have identical (from_state, to_state) transitions"
    severity: "BLOCKING"
  
  provider_coverage_completeness:
    description: "Every canonical event must have coverage for all supported providers"
    severity: "HIGH"
    providers_required: ["Stripe", "Shopify", "PayPal", "WooCommerce"]
  
  critical_event_coverage:
    description: "Critical canonical events must have required=true for all providers (or explicit mitigation)"
    severity: "BLOCKING"
    critical_events: ["PaymentCaptured", "PaymentRefunded"]

# ============================================================================
# CHANGELOG
# ============================================================================

changelog:
  - version: "1.0.0"
    date: "2024-01-15"
    changes: "Initial canonical event taxonomy and state machine definition"
    author: "API Contract Owner"
    phase: "C0"
    validates_against:
      - "db/schema/canonical_schema.yaml (lines 364-469: revenue_ledger)"
      - "api-contracts/openapi/v1/webhooks/*.yaml (v1.1.0 contracts)"



