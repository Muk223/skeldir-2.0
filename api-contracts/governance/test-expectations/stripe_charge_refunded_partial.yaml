# Test Expectation: Stripe Charge Refunded (Partial)
# Payload: stripe_charge_refunded_partial.json
# Purpose: CRITICAL TEST - Proves partial refund handling

test_id: "stripe_charge_refunded_partial_001"
test_type: "edge_case"
canonical_event: "PaymentRefunded"

input_payload_file: "stripe_charge_refunded_partial.json"

precondition:
  description: "Charge ch_3QACppAtHEbrEuTI0Hm3lVxG must exist in 'captured' state with amount_cents=10000"
  revenue_ledger:
    - transaction_id: "ch_3QACppAtHEbrEuTI0Hm3lVxG"
      state: "captured"
      amount_cents: 10000

expected_ledger_state:
  revenue_ledger:
    - transaction_id: "ch_3QACppAtHEbrEuTI0Hm3lVxG"
      order_id: null
      amount_cents: 3000  # PARTIAL REFUND: only refunded amount
      currency: "USD"
      state: "refunded"  # QUESTION: Should partial refunds transition to 'refunded' or stay 'captured'?
      verification_source: "stripe_webhook"
      
  revenue_state_transitions:
    - transaction_id: "ch_3QACppAtHEbrEuTI0Hm3lVxG"
      from_state: "captured"
      to_state: "refunded"

expected_dead_events_count: 0

behavioral_assertions:
  - assertion: "partial_refund_amount_tracking"
    description: "CRITICAL: amount_cents must be 3000 (refunded amount), not 10000 (original amount)"
    expected_value: 3000
    failure_mode: "If 10000, system cannot track net revenue after partial refund"
    
  - assertion: "partial_refund_state_semantics"
    description: "DESIGN QUESTION: Should partial refunds transition to 'refunded' state, or require new 'partially_refunded' state?"
    current_behavior: "refunded"
    potential_issue: "A charge with partial refund and a fully refunded charge have same state, making financial reporting ambiguous"

  - assertion: "net_amount_calculation"
    description: "CRITICAL FAILURE: canonical_schema.yaml lacks 'net_amount' or 'refunded_amount' columns to track cumulative refunds"
    expected_column: "net_amount_cents"
    expected_calculation: "original_amount_cents - SUM(refund_amounts)"
    actual_schema: "COLUMN DOES NOT EXIST - cannot empirically prove net revenue tracking"



