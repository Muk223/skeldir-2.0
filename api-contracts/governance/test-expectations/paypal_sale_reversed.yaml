# Test Expectation: PayPal Sale Reversed (MISSING CANONICAL EVENT)
# Payload: paypal_sale_reversed.json
# Purpose: CANONICAL EVENT GAP TEST - Proves system fails for unmapped events

test_id: "paypal_sale_reversed_gap_001"
test_type: "canonical_event_gap"
canonical_event: "PaymentDisputed"  # SHOULD map to this, but DOESN'T
expected_outcome: "failure"

input_payload_file: "paypal_sale_reversed.json"

current_system_state:
  canonical_events: ["PaymentCaptured", "PaymentRefunded", "OrderCreated", "PaymentDisputed"]
  provider_coverage_matrix:
    PayPal_events: ["PAYMENT.SALE.COMPLETED", "PAYMENT.SALE.REFUNDED"]
    missing_events: ["PAYMENT.SALE.REVERSED", "PAYMENT.SALE.CHARGEBACK"]

expected_system_behavior:
  outcome: "FAILURE - Event Not Mapped"
  error_type: "unknown_provider_event"
  error_message: "PayPal event 'PAYMENT.SALE.REVERSED' not found in provider coverage matrix"

expected_ledger_state:
  revenue_ledger:
    record_count: 0
    reason: "No mapping exists for PAYMENT.SALE.REVERSED"
  
  dead_events:
    - event_id: "WH-test-paypal-reversed-001"
      provider: "paypal"
      event_type: "PAYMENT.SALE.REVERSED"
      error_type: "unknown_provider_event"
      error_message: "Event type not found in canonical mapping"

behavioral_assertions:
  - assertion: "canonical_event_coverage_incomplete"
    description: "CRITICAL FAILURE: PaymentDisputed canonical event exists, but PayPal REVERSED event is not mapped to it"
    canonical_event_exists: true
    canonical_event_name: "PaymentDisputed"
    provider_event_mapped: false
    provider_event_name: "PAYMENT.SALE.REVERSED"
    
  - assertion: "provider_specific_gap"
    description: "PayPal has specific event for chargebacks/reversals that Stripe calls 'charge.dispute.created'"
    paypal_event: "PAYMENT.SALE.REVERSED"
    stripe_equivalent: "charge.dispute.created"
    shopify_equivalent: "N/A"
    gap_evidence: "PayPal REVERSED not in provider_coverage_matrix in canonical-events.yaml"
  
  - assertion: "semantic_taxonomy_failure"
    description: "DESIGN FAILURE: Canonical events were built from known provider events, not from domain semantics"
    methodology_used: "bottom-up (provider events -> canonical)"
    methodology_required: "top-down (business semantics -> canonical -> provider mapping)"
    consequence: "Future provider events will be missed if not in initial implementation"
  
  - assertion: "remediation_required"
    description: "To fix: Add PAYMENT.SALE.REVERSED to provider_coverage_matrix, mapped to PaymentDisputed"
    required_changes:
      - file: "api-contracts/governance/canonical-events.yaml"
        section: "provider_coverage_matrix.PaymentDisputed"
        add_entry:
          provider: "PayPal"
          provider_event: "PAYMENT.SALE.REVERSED"
          delivery: "webhook"
          required: true
          operation_id: "paypalSaleReversed"
      - file: "api-contracts/governance/integration-maps/paypal.yaml"
        add_mapping: "PAYMENT.SALE.REVERSED"



