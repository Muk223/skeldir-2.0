# PayPal Integration Mapping Specification
# Version: 1.0.0
# Purpose: Maps PayPal webhook payloads to internal revenue_ledger fields
# API Version: v1/v2 (PayPal REST API)
# Source: api-contracts/openapi/v1/webhooks/paypal.yaml

provider: "PayPal"
api_version: "v1/v2"
version: "1.0.0"
last_updated: "2024-01-15"

# PayPal-specific notes
notes:
  - "PayPal sends amounts as nested object with total and currency"
  - "Amount total is string decimal (must convert to cents)"
  - "Currency codes are uppercase"
  - "Timestamps are ISO 8601 date-time strings"
  - "Transaction IDs are strings"
  - "Refund events reference parent_payment for linking"

mappings:
  PAYMENT.SALE.COMPLETED:
    canonical_event: "PaymentCaptured"
    description: "PayPal sale completed successfully"
    
    fields:
      - source_path: "id"
        target_table: "revenue_ledger"
        target_column: "transaction_id"
        transform: "as-is"
        required: true
        data_type: "string"
        example_value: "PAY-123456789ABCDEF"
        notes: "PayPal transaction ID"
      
      - source_path: "amount.total"
        target_table: "revenue_ledger"
        target_column: "amount_cents"
        transform: "decimal_string_to_cents"
        required: true
        data_type: "string"
        example_value: "99.99"
        transformed_value: 9999
        notes: "Nested amount object - convert total to cents"
      
      - source_path: "amount.currency"
        target_table: "revenue_ledger"
        target_column: "currency"
        transform: "as-is"
        required: true
        data_type: "string"
        example_value: "USD"
        notes: "Already uppercase"
      
      - source_path: "create_time"
        target_table: "revenue_ledger"
        target_column: "verification_timestamp"
        transform: "iso8601_to_timestamptz"
        required: true
        data_type: "string"
        example_value: "2025-11-10T14:30:00Z"
        notes: "ISO 8601 to timestamptz"
      
      - source_path: null
        target_table: "revenue_ledger"
        target_column: "verification_source"
        transform: "constant"
        constant_value: "paypal_webhook"
        required: true
    
    state_transition:
      from_state: "authorized"
      to_state: "captured"
      ledger_table: "revenue_state_transitions"
      notes: "Sale completed - revenue captured"
    
    idempotency:
      key_field: "transaction_id"
      key_source: "id"
      duplicate_handling: "skip"
      notes: "Idempotent on transaction ID"
  
  PAYMENT.SALE.REFUNDED:
    canonical_event: "PaymentRefunded"
    description: "PayPal sale refunded"
    
    fields:
      - source_path: "id"
        target_table: "revenue_ledger"
        target_column: "transaction_id"
        transform: "as-is"
        required: true
        data_type: "string"
        example_value: "RF123456789"
        notes: "PayPal refund ID"
      
      - source_path: "parent_payment"
        target_table: "revenue_ledger"
        target_column: "order_id"
        transform: "as-is"
        required: true
        data_type: "string"
        example_value: "PAY-123456789ABCDEF"
        notes: "Links to original payment transaction"
      
      - source_path: "amount.total"
        target_table: "revenue_ledger"
        target_column: "amount_cents"
        transform: "decimal_string_to_cents"
        required: true
        data_type: "string"
        example_value: "39.99"
        transformed_value: 3999
        notes: "Refund amount from nested object"
      
      - source_path: "amount.currency"
        target_table: "revenue_ledger"
        target_column: "currency"
        transform: "as-is"
        required: true
        data_type: "string"
        example_value: "USD"
      
      - source_path: "create_time"
        target_table: "revenue_ledger"
        target_column: "verification_timestamp"
        transform: "iso8601_to_timestamptz"
        required: true
        data_type: "string"
        example_value: "2025-11-10T15:30:00Z"
      
      - source_path: null
        target_table: "revenue_ledger"
        target_column: "verification_source"
        transform: "constant"
        constant_value: "paypal_webhook"
        required: true
    
    state_transition:
      from_state: "captured"
      to_state: "refunded"
      ledger_table: "revenue_state_transitions"
      notes: "Sale refunded - revenue reversed"
    
    idempotency:
      key_field: "transaction_id"
      key_source: "id"
      duplicate_handling: "skip"
      notes: "Refund events are idempotent"

error_handling:
  missing_required_field:
    action: "quarantine"
    target_table: "dead_events"
    log_level: "ERROR"
  
  malformed_value:
    action: "quarantine"
    target_table: "dead_events"
    log_level: "ERROR"
  
  duplicate_event:
    action: "skip"
    log_level: "INFO"
  
  nested_field_missing:
    action: "quarantine"
    target_table: "dead_events"
    log_level: "ERROR"
    notes: "amount.total or amount.currency missing from nested object"





