# Stripe Integration Mapping Specification
# Version: 1.0.0
# Purpose: Maps Stripe webhook payloads to internal revenue_ledger fields
# API Version: 2023-10 (Stripe API)
# Source: api-contracts/openapi/v1/webhooks/stripe.yaml

provider: "Stripe"
api_version: "2023-10"
version: "1.0.0"
last_updated: "2024-01-15"

# Stripe-specific notes
notes:
  - "Stripe sends amounts in cents (no conversion needed for amount_cents)"
  - "Currency codes are lowercase per Stripe API spec (must convert to uppercase)"
  - "Timestamps are Unix epoch integers"
  - "charge.* events use legacy Charges API"
  - "payment_intent.* events use modern Payment Intents API"

mappings:
  charge.succeeded:
    canonical_event: "PaymentCaptured"
    description: "Stripe charge successfully captured (legacy Charges API)"
    
    fields:
      - source_path: "data.object.id"
        target_table: "revenue_ledger"
        target_column: "transaction_id"
        transform: "as-is"
        required: true
        data_type: "string"
        example_value: "ch_3QACppAtHEbrEuTI0Hm3lVxG"
        notes: "Stripe charge ID serves as unique transaction identifier"
      
      - source_path: "data.object.amount"
        target_table: "revenue_ledger"
        target_column: "amount_cents"
        transform: "as-is"
        required: true
        data_type: "integer"
        example_value: 10000
        notes: "Already in cents, no conversion needed"
      
      - source_path: "data.object.currency"
        target_table: "revenue_ledger"
        target_column: "currency"
        transform: "uppercase"
        required: true
        data_type: "string"
        example_value: "usd"
        transformed_value: "USD"
        notes: "Stripe sends lowercase, ledger expects uppercase ISO 4217"
      
      - source_path: "data.object.created"
        target_table: "revenue_ledger"
        target_column: "verification_timestamp"
        transform: "unix_to_timestamptz"
        required: true
        data_type: "integer"
        example_value: 1609459200
        transformed_value: "2021-01-01T00:00:00Z"
        notes: "Unix timestamp to PostgreSQL timestamptz"
      
      - source_path: null
        target_table: "revenue_ledger"
        target_column: "verification_source"
        transform: "constant"
        constant_value: "stripe_webhook"
        required: true
        notes: "Hardcoded verification source identifier"
    
    state_transition:
      from_state: "authorized"
      to_state: "captured"
      ledger_table: "revenue_state_transitions"
    
    idempotency:
      key_field: "transaction_id"
      key_source: "data.object.id"
      duplicate_handling: "skip"
      notes: "Idempotent on transaction_id - skip duplicate events"
  
  charge.refunded:
    canonical_event: "PaymentRefunded"
    description: "Stripe charge refunded (full or partial)"
    
    fields:
      - source_path: "data.object.id"
        target_table: "revenue_ledger"
        target_column: "transaction_id"
        transform: "as-is"
        required: true
        data_type: "string"
        example_value: "ch_3QACppAtHEbrEuTI0Hm3lVxG"
        notes: "Same charge ID, state transition to refunded"
      
      - source_path: "data.object.amount_refunded"
        target_table: "revenue_ledger"
        target_column: "amount_cents"
        transform: "as-is"
        required: true
        data_type: "integer"
        example_value: 10000
        notes: "Refund amount in cents"
      
      - source_path: "data.object.currency"
        target_table: "revenue_ledger"
        target_column: "currency"
        transform: "uppercase"
        required: true
        data_type: "string"
        example_value: "usd"
        transformed_value: "USD"
      
      - source_path: "data.object.created"
        target_table: "revenue_ledger"
        target_column: "verification_timestamp"
        transform: "unix_to_timestamptz"
        required: true
        data_type: "integer"
        example_value: 1609459260
      
      - source_path: null
        target_table: "revenue_ledger"
        target_column: "verification_source"
        transform: "constant"
        constant_value: "stripe_webhook"
        required: true
    
    state_transition:
      from_state: "captured"
      to_state: "refunded"
      ledger_table: "revenue_state_transitions"
    
    idempotency:
      key_field: "transaction_id"
      key_source: "data.object.id"
      duplicate_handling: "update_state"
      notes: "Update existing transaction to refunded state"
  
  payment_intent.succeeded:
    canonical_event: "PaymentCaptured"
    description: "Stripe Payment Intent succeeded (modern Payment Intents API)"
    
    fields:
      - source_path: "data.object.id"
        target_table: "revenue_ledger"
        target_column: "transaction_id"
        transform: "as-is"
        required: true
        data_type: "string"
        example_value: "pi_3QACppAtHEbrEuTI0Hm3lVxG"
        notes: "Payment Intent ID as transaction identifier"
      
      - source_path: "data.object.amount"
        target_table: "revenue_ledger"
        target_column: "amount_cents"
        transform: "as-is"
        required: true
        data_type: "integer"
        example_value: 10000
      
      - source_path: "data.object.currency"
        target_table: "revenue_ledger"
        target_column: "currency"
        transform: "uppercase"
        required: true
        data_type: "string"
        example_value: "usd"
        transformed_value: "USD"
      
      - source_path: "data.object.created"
        target_table: "revenue_ledger"
        target_column: "verification_timestamp"
        transform: "unix_to_timestamptz"
        required: true
        data_type: "integer"
        example_value: 1609459200
      
      - source_path: null
        target_table: "revenue_ledger"
        target_column: "verification_source"
        transform: "constant"
        constant_value: "stripe_webhook"
        required: true
    
    state_transition:
      from_state: "authorized"
      to_state: "captured"
      ledger_table: "revenue_state_transitions"
    
    idempotency:
      key_field: "transaction_id"
      key_source: "data.object.id"
      duplicate_handling: "skip"

error_handling:
  missing_required_field:
    action: "quarantine"
    target_table: "dead_events"
    log_level: "ERROR"
    notes: "Send to dead_events table for manual review"
  
  malformed_value:
    action: "quarantine"
    target_table: "dead_events"
    log_level: "ERROR"
    notes: "Invalid data type or format"
  
  duplicate_event:
    action: "skip"
    log_level: "INFO"
    notes: "Idempotent - skip processing, log for monitoring"
  
  currency_mismatch:
    action: "quarantine"
    target_table: "dead_events"
    log_level: "ERROR"
    notes: "Currency changed between original and refund"



