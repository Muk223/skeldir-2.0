# Shopify Integration Mapping Specification
# Version: 1.0.0
# Purpose: Maps Shopify webhook payloads to internal revenue_ledger fields
# API Version: 2024-01 (Shopify Admin REST API)
# Source: api-contracts/openapi/v1/webhooks/shopify.yaml

provider: "Shopify"
api_version: "2024-01"
version: "1.0.0"
last_updated: "2024-01-15"

# Shopify-specific notes
notes:
  - "Shopify sends amounts as string decimals (must convert to cents)"
  - "Currency codes are uppercase per Shopify API (no conversion needed)"
  - "Timestamps are ISO 8601 date-time strings"
  - "Order ID is integer type"
  - "Financial status distinguishes created from paid orders"

mappings:
  orders/create:
    canonical_event: "OrderCreated"
    description: "Shopify order created (may not be paid yet)"
    
    fields:
      - source_path: "id"
        target_table: "revenue_ledger"
        target_column: "order_id"
        transform: "int_to_string"
        required: true
        data_type: "integer"
        example_value: 1234567890
        transformed_value: "1234567890"
        notes: "Shopify order ID (integer) converted to string for order_id"
      
      - source_path: "id"
        target_table: "revenue_ledger"
        target_column: "transaction_id"
        transform: "prefix_provider"
        prefix: "shopify_order_"
        required: true
        data_type: "integer"
        example_value: 1234567890
        transformed_value: "shopify_order_1234567890"
        notes: "Prefix with provider to ensure uniqueness across providers"
      
      - source_path: "total_price"
        target_table: "revenue_ledger"
        target_column: "amount_cents"
        transform: "decimal_string_to_cents"
        required: true
        data_type: "string"
        example_value: "129.99"
        transformed_value: 12999
        notes: "Convert decimal string to integer cents: '129.99' -> 12999"
      
      - source_path: "currency"
        target_table: "revenue_ledger"
        target_column: "currency"
        transform: "as-is"
        required: true
        data_type: "string"
        example_value: "USD"
        notes: "Already uppercase, no conversion needed"
      
      - source_path: "created_at"
        target_table: "revenue_ledger"
        target_column: "verification_timestamp"
        transform: "iso8601_to_timestamptz"
        required: true
        data_type: "string"
        example_value: "2025-11-10T14:30:00Z"
        notes: "ISO 8601 string to PostgreSQL timestamptz"
      
      - source_path: null
        target_table: "revenue_ledger"
        target_column: "verification_source"
        transform: "constant"
        constant_value: "shopify_webhook"
        required: true
    
    state_transition:
      from_state: null
      to_state: "authorized"
      ledger_table: "revenue_state_transitions"
      notes: "Initial order creation - awaiting payment"
    
    idempotency:
      key_field: "order_id"
      key_source: "id"
      duplicate_handling: "skip"
      notes: "Idempotent on order_id"
  
  orders/paid:
    canonical_event: "PaymentCaptured"
    description: "Shopify order paid (payment confirmed)"
    
    fields:
      - source_path: "id"
        target_table: "revenue_ledger"
        target_column: "order_id"
        transform: "int_to_string"
        required: true
        data_type: "integer"
        example_value: 1234567890
        transformed_value: "1234567890"
      
      - source_path: "id"
        target_table: "revenue_ledger"
        target_column: "transaction_id"
        transform: "prefix_provider"
        prefix: "shopify_order_"
        required: true
        data_type: "integer"
        example_value: 1234567890
        transformed_value: "shopify_order_1234567890"
      
      - source_path: "total_price"
        target_table: "revenue_ledger"
        target_column: "amount_cents"
        transform: "decimal_string_to_cents"
        required: true
        data_type: "string"
        example_value: "129.99"
        transformed_value: 12999
      
      - source_path: "currency"
        target_table: "revenue_ledger"
        target_column: "currency"
        transform: "as-is"
        required: true
        data_type: "string"
        example_value: "USD"
      
      - source_path: "created_at"
        target_table: "revenue_ledger"
        target_column: "verification_timestamp"
        transform: "iso8601_to_timestamptz"
        required: true
        data_type: "string"
        example_value: "2025-11-10T14:30:00Z"
      
      - source_path: null
        target_table: "revenue_ledger"
        target_column: "verification_source"
        transform: "constant"
        constant_value: "shopify_webhook"
        required: true
    
    state_transition:
      from_state: "authorized"
      to_state: "captured"
      ledger_table: "revenue_state_transitions"
      notes: "Order payment confirmed - revenue recognized"
    
    idempotency:
      key_field: "transaction_id"
      key_source: "id"
      duplicate_handling: "update_state"
      notes: "Update existing order to captured state"
  
  refunds/create:
    canonical_event: "PaymentRefunded"
    description: "Shopify refund created for order"
    
    fields:
      - source_path: "id"
        target_table: "revenue_ledger"
        target_column: "transaction_id"
        transform: "prefix_provider"
        prefix: "shopify_refund_"
        required: true
        data_type: "integer"
        example_value: 9876543210
        transformed_value: "shopify_refund_9876543210"
        notes: "Refund ID becomes transaction_id"
      
      - source_path: "order_id"
        target_table: "revenue_ledger"
        target_column: "order_id"
        transform: "int_to_string"
        required: true
        data_type: "integer"
        example_value: 1234567890
        transformed_value: "1234567890"
        notes: "Links refund to original order"
      
      - source_path: "refund_amount"
        target_table: "revenue_ledger"
        target_column: "amount_cents"
        transform: "decimal_string_to_cents"
        required: true
        data_type: "string"
        example_value: "29.99"
        transformed_value: 2999
        notes: "Refund amount in cents"
      
      - source_path: "currency"
        target_table: "revenue_ledger"
        target_column: "currency"
        transform: "as-is"
        required: true
        data_type: "string"
        example_value: "USD"
      
      - source_path: "created_at"
        target_table: "revenue_ledger"
        target_column: "verification_timestamp"
        transform: "iso8601_to_timestamptz"
        required: true
        data_type: "string"
        example_value: "2025-11-10T15:30:00Z"
      
      - source_path: null
        target_table: "revenue_ledger"
        target_column: "verification_source"
        transform: "constant"
        constant_value: "shopify_webhook"
        required: true
    
    state_transition:
      from_state: "captured"
      to_state: "refunded"
      ledger_table: "revenue_state_transitions"
      notes: "Order refunded - revenue reversed"
    
    idempotency:
      key_field: "transaction_id"
      key_source: "id"
      duplicate_handling: "skip"
      notes: "Refund events are idempotent"

error_handling:
  missing_required_field:
    action: "quarantine"
    target_table: "dead_events"
    log_level: "ERROR"
  
  malformed_value:
    action: "quarantine"
    target_table: "dead_events"
    log_level: "ERROR"
  
  duplicate_event:
    action: "skip"
    log_level: "INFO"
  
  decimal_conversion_error:
    action: "quarantine"
    target_table: "dead_events"
    log_level: "ERROR"
    notes: "Failed to convert total_price string to cents"





