# WooCommerce Integration Mapping Specification
# Version: 1.0.0
# Purpose: Maps WooCommerce webhook payloads to internal revenue_ledger fields
# API Version: v3 (WooCommerce REST API)
# Source: api-contracts/openapi/v1/webhooks/woocommerce.yaml

provider: "WooCommerce"
api_version: "v3"
version: "1.0.0"
last_updated: "2024-01-15"

# WooCommerce-specific notes
notes:
  - "WooCommerce sends amounts as string decimals (must convert to cents)"
  - "Currency codes are uppercase"
  - "Timestamps are ISO 8601 date-time strings"
  - "Order ID is integer type"
  - "Status field distinguishes created from completed orders"

mappings:
  order/created:
    canonical_event: "OrderCreated"
    description: "WooCommerce order created (may not be paid yet)"
    
    fields:
      - source_path: "id"
        target_table: "revenue_ledger"
        target_column: "order_id"
        transform: "int_to_string"
        required: true
        data_type: "integer"
        example_value: 1234
        transformed_value: "1234"
        notes: "WooCommerce order ID"
      
      - source_path: "id"
        target_table: "revenue_ledger"
        target_column: "transaction_id"
        transform: "prefix_provider"
        prefix: "woocommerce_order_"
        required: true
        data_type: "integer"
        example_value: 1234
        transformed_value: "woocommerce_order_1234"
        notes: "Prefix with provider for uniqueness"
      
      - source_path: "total"
        target_table: "revenue_ledger"
        target_column: "amount_cents"
        transform: "decimal_string_to_cents"
        required: true
        data_type: "string"
        example_value: "149.99"
        transformed_value: 14999
        notes: "Convert total to cents"
      
      - source_path: "currency"
        target_table: "revenue_ledger"
        target_column: "currency"
        transform: "as-is"
        required: true
        data_type: "string"
        example_value: "USD"
        notes: "Already uppercase"
      
      - source_path: "date_created"
        target_table: "revenue_ledger"
        target_column: "verification_timestamp"
        transform: "iso8601_to_timestamptz"
        required: true
        data_type: "string"
        example_value: "2025-11-10T14:30:00Z"
      
      - source_path: null
        target_table: "revenue_ledger"
        target_column: "verification_source"
        transform: "constant"
        constant_value: "woocommerce_webhook"
        required: true
    
    state_transition:
      from_state: null
      to_state: "authorized"
      ledger_table: "revenue_state_transitions"
      notes: "Order created - awaiting completion"
    
    idempotency:
      key_field: "order_id"
      key_source: "id"
      duplicate_handling: "skip"
  
  order/completed:
    canonical_event: "PaymentCaptured"
    description: "WooCommerce order completed/paid"
    
    fields:
      - source_path: "id"
        target_table: "revenue_ledger"
        target_column: "order_id"
        transform: "int_to_string"
        required: true
        data_type: "integer"
        example_value: 1234
        transformed_value: "1234"
      
      - source_path: "id"
        target_table: "revenue_ledger"
        target_column: "transaction_id"
        transform: "prefix_provider"
        prefix: "woocommerce_order_"
        required: true
        data_type: "integer"
        example_value: 1234
        transformed_value: "woocommerce_order_1234"
      
      - source_path: "total"
        target_table: "revenue_ledger"
        target_column: "amount_cents"
        transform: "decimal_string_to_cents"
        required: true
        data_type: "string"
        example_value: "149.99"
        transformed_value: 14999
      
      - source_path: "currency"
        target_table: "revenue_ledger"
        target_column: "currency"
        transform: "as-is"
        required: true
        data_type: "string"
        example_value: "USD"
      
      - source_path: "date_completed"
        target_table: "revenue_ledger"
        target_column: "verification_timestamp"
        transform: "iso8601_to_timestamptz"
        required: true
        data_type: "string"
        example_value: "2025-11-10T14:30:00Z"
        notes: "Use date_completed not date_created"
      
      - source_path: null
        target_table: "revenue_ledger"
        target_column: "verification_source"
        transform: "constant"
        constant_value: "woocommerce_webhook"
        required: true
    
    state_transition:
      from_state: "authorized"
      to_state: "captured"
      ledger_table: "revenue_state_transitions"
      notes: "Order completed - revenue captured"
    
    idempotency:
      key_field: "transaction_id"
      key_source: "id"
      duplicate_handling: "update_state"
  
  order/refunded:
    canonical_event: "PaymentRefunded"
    description: "WooCommerce order refunded"
    
    fields:
      - source_path: "id"
        target_table: "revenue_ledger"
        target_column: "transaction_id"
        transform: "prefix_provider"
        prefix: "woocommerce_refund_"
        required: true
        data_type: "integer"
        example_value: 5678
        transformed_value: "woocommerce_refund_5678"
        notes: "Refund ID as transaction"
      
      - source_path: "order_id"
        target_table: "revenue_ledger"
        target_column: "order_id"
        transform: "int_to_string"
        required: true
        data_type: "integer"
        example_value: 1234
        transformed_value: "1234"
        notes: "Links to original order"
      
      - source_path: "refund_amount"
        target_table: "revenue_ledger"
        target_column: "amount_cents"
        transform: "decimal_string_to_cents"
        required: true
        data_type: "string"
        example_value: "49.99"
        transformed_value: 4999
      
      - source_path: "currency"
        target_table: "revenue_ledger"
        target_column: "currency"
        transform: "as-is"
        required: true
        data_type: "string"
        example_value: "USD"
      
      - source_path: "date_created"
        target_table: "revenue_ledger"
        target_column: "verification_timestamp"
        transform: "iso8601_to_timestamptz"
        required: true
        data_type: "string"
        example_value: "2025-11-10T15:30:00Z"
      
      - source_path: null
        target_table: "revenue_ledger"
        target_column: "verification_source"
        transform: "constant"
        constant_value: "woocommerce_webhook"
        required: true
    
    state_transition:
      from_state: "captured"
      to_state: "refunded"
      ledger_table: "revenue_state_transitions"
      notes: "Order refunded - revenue reversed"
    
    idempotency:
      key_field: "transaction_id"
      key_source: "id"
      duplicate_handling: "skip"

error_handling:
  missing_required_field:
    action: "quarantine"
    target_table: "dead_events"
    log_level: "ERROR"
  
  malformed_value:
    action: "quarantine"
    target_table: "dead_events"
    log_level: "ERROR"
  
  duplicate_event:
    action: "skip"
    log_level: "INFO"
  
  decimal_conversion_error:
    action: "quarantine"
    target_table: "dead_events"
    log_level: "ERROR"



