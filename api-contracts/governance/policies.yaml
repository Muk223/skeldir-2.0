# Skeldir API Operational Policies Registry
# Version: 1.0
# Purpose: Centralized definition of operational policies that govern API behavior,
#          including rate limiting, idempotency, error handling, and deprecation

operational_policies:
  # Rate Limiting Policy
  rate_limiting:
    default_limit: 100
    window_minutes: 1
    per_scope: tenant
    description: "Standard rate limit: 100 requests per minute per tenant"
    rationale: "Prevents abuse while allowing reasonable usage patterns for typical integrations"
    
    headers_required:
      - name: "X-RateLimit-Limit"
        type: integer
        description: "Maximum requests allowed in current window"
        example: 100
      
      - name: "X-RateLimit-Remaining"
        type: integer
        description: "Requests remaining in current window"
        example: 95
      
      - name: "X-RateLimit-Reset"
        type: integer
        format: int64
        description: "Unix timestamp when rate limit window resets"
        example: 1609459200
    
    response_429_required: true
    response_429_schema:
      description: "429 Too Many Requests must include Problem schema with rate limit headers"
      schema_ref: "#/components/schemas/Problem"
      headers:
        - X-RateLimit-Limit
        - X-RateLimit-Remaining
        - X-RateLimit-Reset
        - Retry-After
    
    retry_after_header:
      required: true
      format: "Seconds until window reset (integer)"
      example: 30
    
    exemptions:
      - endpoint_pattern: "/api/health"
        reason: "Health check endpoints exempt from rate limiting for uptime monitoring"
      
      - endpoint_pattern: "/webhooks/*"
        custom_limit: 1000
        custom_window_minutes: 1
        reason: "Webhook ingestion requires higher throughput (1000 req/min)"
    
    enforcement:
      - location: "API Gateway / Middleware"
        mechanism: "Token bucket algorithm per tenant_id"
      - location: "Contract"
        mechanism: "x-rate-limit extension in OpenAPI info section"
      - location: "Tests"
        mechanism: "Rate limit behavioral tests with 429 response validation"
    
    client_guidance:
      - "Implement exponential backoff on 429 responses"
      - "Parse X-RateLimit-Remaining to proactively throttle requests"
      - "Use Retry-After header value to determine wait time"
      - "Track X-RateLimit-Reset for window boundary awareness"
  
  # Idempotency Policy
  idempotency:
    header_name: "X-Idempotency-Key"
    format: uuid
    description: "Idempotency key prevents duplicate processing of state-changing requests"
    rationale: "Network failures and retries can cause duplicate requests; idempotency ensures exactly-once semantics"
    
    required_for:
      methods:
        - POST
        - PUT
        - PATCH
      exceptions:
        - method: POST
          endpoint_pattern: "/api/auth/login"
          reason: "Login is naturally idempotent (same credentials → same tokens)"
        - method: GET
          reason: "GET is naturally idempotent per HTTP spec"
        - method: DELETE
          reason: "DELETE is naturally idempotent per HTTP spec"
    
    webhook_idempotency:
      mechanism: "Platform-specific event ID extracted from payload"
      storage: "Idempotency table with unique constraint on (tenant_id, platform, event_id)"
      ttl: "30 days retention for idempotency keys"
      fields:
        shopify: "id (integer)"
        woocommerce: "id (integer)"
        stripe: "id (string, format: 'ch_*')"
        paypal: "id (string)"
    
    contract_metadata:
      extension_name: "x-idempotency-key"
      extension_values:
        header: "X-Idempotency-Key"
        payload_field: "id"  # For webhooks
    
    duplicate_handling:
      behavior: "Return original response (status code + body) from first request"
      status_codes:
        - 200: "Return original 200 response"
        - 201: "Return original 201 response (do not re-create resource)"
        - 4xx: "Return original error response"
        - 5xx: "Retry processing (server errors are not cached for idempotency)"
    
    enforcement:
      - location: "Middleware"
        mechanism: "Check idempotency key in cache/database before processing"
      - location: "Contract"
        mechanism: "X-Idempotency-Key header documented in all state-changing endpoints"
      - location: "Tests"
        mechanism: "Duplicate request tests with same idempotency key"
    
    client_guidance:
      - "Generate UUID v4 for each unique request intent"
      - "Reuse same idempotency key for retries of the same request"
      - "Do not reuse keys across different request bodies"
      - "Idempotency keys are scoped per tenant (safe to use same UUID across tenants)"
  
  # Error Model Policy (RFC 7807 Problem Details)
  error_model:
    schema: "Problem"
    standard: "RFC 7807 (Problem Details for HTTP APIs)"
    content_type: "application/json"  # RFC 7807 allows application/json
    description: "All 4xx and 5xx responses must use standardized Problem schema"
    rationale: "Consistent error format enables generic client error handling and debugging"
    
    required_fields:
      - name: "type"
        type: string
        format: uri
        description: "URI reference identifying the problem type"
        example: "https://api.skeldir.com/problems/validation-error"
      
      - name: "title"
        type: string
        description: "Short, human-readable summary of the problem type"
        example: "Validation Error"
      
      - name: "status"
        type: integer
        description: "HTTP status code (MUST match response status)"
        example: 400
      
      - name: "detail"
        type: string
        description: "Human-readable explanation specific to this occurrence"
        example: "The 'currency' field must be a 3-letter ISO 4217 code"
    
    optional_fields:
      - name: "instance"
        type: string
        format: uri
        description: "URI reference identifying the specific occurrence"
        example: "/api/attribution/revenue/realtime"
    
    skeldir_extensions:
      - name: "error_id"
        type: string
        format: uuid
        description: "Unique identifier for this error occurrence (for support and debugging)"
        example: "550e8400-e29b-41d4-a716-446655440000"
      
      - name: "correlation_id"
        type: string
        format: uuid
        description: "Correlation ID from X-Correlation-ID header (for distributed tracing)"
        example: "550e8400-e29b-41d4-a716-446655440000"
    
    standard_error_types:
      - uri: "https://api.skeldir.com/problems/validation-error"
        status: 400
        title: "Validation Error"
        use_case: "Request body or query parameters fail validation"
      
      - uri: "https://api.skeldir.com/problems/unauthorized"
        status: 401
        title: "Unauthorized"
        use_case: "Missing or invalid authentication token"
      
      - uri: "https://api.skeldir.com/problems/forbidden"
        status: 403
        title: "Forbidden"
        use_case: "Valid token but insufficient permissions"
      
      - uri: "https://api.skeldir.com/problems/not-found"
        status: 404
        title: "Not Found"
        use_case: "Requested resource does not exist"
      
      - uri: "https://api.skeldir.com/problems/rate-limit-exceeded"
        status: 429
        title: "Too Many Requests"
        use_case: "Client exceeded rate limit"
      
      - uri: "https://api.skeldir.com/problems/invalid-webhook-signature"
        status: 400
        title: "Invalid Webhook Signature"
        use_case: "Webhook HMAC/RSA signature validation failed"
      
      - uri: "https://api.skeldir.com/problems/internal-server-error"
        status: 500
        title: "Internal Server Error"
        use_case: "Unexpected server error"
    
    enforcement:
      - location: "Contract"
        mechanism: "All 4xx/5xx responses reference Problem schema"
      - location: "Backend"
        mechanism: "Exception handlers generate Problem responses"
      - location: "Tests"
        mechanism: "Error response validation against Problem schema"
    
    client_guidance:
      - "Parse 'type' URI to determine programmatic error handling"
      - "Display 'title' and 'detail' to end users for human-readable errors"
      - "Include 'error_id' in support requests for rapid issue resolution"
      - "Use 'correlation_id' for distributed tracing across API calls"
  
  # Deprecation Policy
  deprecation:
    notice_window_days: 90
    description: "Minimum 90-day notice before removing or breaking changes to API features"
    rationale: "Provides integrations sufficient time to migrate without disruption"
    
    migration_guide_required: true
    migration_guide_template: "api-contracts/MIGRATION_TEMPLATE.md"
    
    sunset_header_required: true
    sunset_header_format: "HTTP Date (RFC 7231)"
    sunset_header_example: "Sunset: Sat, 31 Dec 2025 23:59:59 GMT"
    
    deprecation_metadata:
      openapi_field: "deprecated"
      openapi_value: true
      extension_name: "x-deprecation"
      extension_schema:
        sunset_date:
          type: string
          format: date
          description: "Date when feature will be removed (ISO 8601)"
          example: "2025-12-31"
        
        alternative:
          type: string
          description: "Recommended alternative endpoint or field"
          example: "/api/v2/attribution/revenue/realtime"
        
        migration_guide_url:
          type: string
          format: uri
          description: "URL to migration guide documentation"
          example: "https://docs.skeldir.com/migrations/v1-to-v2"
    
    communication_channels:
      - "API documentation (Redoc/Swagger UI) with deprecation notices"
      - "Deprecation warnings in API responses (X-Deprecation-Warning header)"
      - "Email notifications to registered API consumers"
      - "Changelog updates (CHANGELOG.md)"
      - "GitHub release notes"
    
    enforcement:
      - location: "Contract"
        mechanism: "deprecated: true on fields/endpoints + x-deprecation metadata"
      - location: "Backend"
        mechanism: "Sunset header in responses for deprecated endpoints"
      - location: "Monitoring"
        mechanism: "Track usage of deprecated endpoints to assess migration progress"
    
    version_impact:
      breaking_change: "Removal of deprecated feature requires major version bump (v1 → v2)"
      non_breaking_change: "Adding deprecation notice is non-breaking (v1.0 → v1.1)"
    
    client_guidance:
      - "Monitor X-Deprecation-Warning headers in API responses"
      - "Subscribe to API changelog for deprecation announcements"
      - "Migrate before sunset_date to avoid service disruption"
      - "Test against new alternatives before old endpoint is removed"
  
  # Security Schemes
  security:
    authentication:
      scheme: "BearerAuth"
      type: "http"
      scheme_value: "bearer"
      bearer_format: "JWT"
      description: "JWT Bearer token authentication for user-facing APIs"
      
      token_lifetime:
        access_token: "1 hour (3600 seconds)"
        refresh_token: "7 days"
      
      token_claims:
        - "sub: User ID"
        - "tenant_id: Tenant identifier for multi-tenant isolation"
        - "exp: Expiration timestamp"
        - "iat: Issued at timestamp"
      
      enforcement:
        - location: "Contract"
          mechanism: "security: [BearerAuth: []] on authenticated endpoints"
        - location: "Middleware"
          mechanism: "JWT validation with signature verification and expiration check"
    
    webhook_authentication:
      mechanism: "HMAC/RSA signature verification"
      description: "Webhooks use platform-specific signature validation instead of Bearer tokens"
      
      platforms:
        shopify:
          header: "X-Shopify-Hmac-Sha256"
          algorithm: "HMAC-SHA256"
          secret: "Tenant-configured webhook secret"
        
        woocommerce:
          header: "X-WC-Webhook-Signature"
          algorithm: "HMAC-SHA256"
          secret: "Tenant-configured webhook secret"
        
        stripe:
          header: "Stripe-Signature"
          algorithm: "HMAC-SHA256 with timestamp and event ID"
          secret: "Stripe webhook endpoint secret"
        
        paypal:
          headers:
            - "PAYPAL-AUTH-ALGO"
            - "PAYPAL-CERT-URL"
            - "PAYPAL-TRANSMISSION-SIG"
          algorithm: "RSA-SHA256"
          verification: "Certificate-based signature verification"
      
      enforcement:
        - location: "Contract"
          mechanism: "Required signature headers documented in webhook endpoints"
        - location: "Backend"
          mechanism: "Signature validation before webhook processing"
        - location: "Tests"
          mechanism: "Invalid signature rejection tests"
  
  # Correlation & Tracing
  distributed_tracing:
    header: "X-Correlation-ID"
    format: uuid
    required: true
    description: "All requests and responses must include correlation ID for distributed tracing"
    
    behavior:
      client_provided: "Use client-provided X-Correlation-ID if present"
      generated: "Generate UUID v4 if not provided by client"
      propagation: "Include in all downstream service calls and logs"
    
    enforcement:
      - location: "Contract"
        mechanism: "X-Correlation-ID header required on all endpoints"
      - location: "Middleware"
        mechanism: "Auto-generation and response header injection"
      - location: "Logs"
        mechanism: "Structured logging with correlation_id field"

# Policy Enforcement Automation
enforcement_automation:
  spectral_rules:
    - rule: "rate-limit-headers-required"
      description: "429 responses must include X-RateLimit-* headers"
      severity: error
    
    - rule: "problem-schema-for-errors"
      description: "4xx/5xx responses must use Problem schema"
      severity: error
    
    - rule: "operation-security-defined"
      description: "All operations must explicitly define security requirements"
      severity: error
    
    - rule: "correlation-id-header-required"
      description: "All endpoints should support X-Correlation-ID header"
      severity: warn
    
    - rule: "idempotency-key-for-state-changes"
      description: "POST/PUT/PATCH operations should accept X-Idempotency-Key"
      severity: warn
  
  manual_reviews:
    - checkpoint: "Deprecation notices"
      reviewer: "Version Steward"
      frequency: "Per contract change with deprecated: true"
    
    - checkpoint: "Rate limit exemptions"
      reviewer: "Policy Steward"
      frequency: "Per x-rate-limit-override addition"
    
    - checkpoint: "Security scheme changes"
      reviewer: "Policy Steward + Security Team"
      frequency: "Per security scheme modification"

# Changelog
changelog:
  - version: "1.0"
    date: "2024-01-15"
    changes: "Initial policies registry created from architectural requirements and RFC 7807 compliance"
    author: "API Governance Lead"



