# OpenAPI Extension Schema: x-mapping
# Version: 1.0.0
# Purpose: Embeds integration mapping metadata directly in OpenAPI contracts
# Specification: https://swagger.io/specification/#specification-extensions

# This file defines custom OpenAPI extensions for contract-embedded mapping metadata.
# These extensions create a direct, machine-readable link from API contracts to
# internal ledger transformations, enabling automated validation and code generation.

metadata:
  version: "1.0.0"
  last_updated: "2024-01-15"
  specification: "OpenAPI 3.0+"
  purpose: "Contract-embedded mapping metadata for mechanical traceability"

# Extension: x-mapping (schema-level)
# Applied to: Request/response schemas (e.g., StripeChargeSucceededRequest)
# Purpose: Links webhook payload to canonical event and state transition
x-mapping:
  description: "Schema-level mapping extension linking payload to canonical event"
  location: "components.schemas.{SchemaName}"
  required_fields:
    - canonical_event
    - state_transition
  optional_fields:
    - idempotency
    - error_handling
  
  schema:
    type: object
    properties:
      canonical_event:
        type: string
        description: "Canonical event type from canonical-events.yaml"
        enum:
          - PaymentCaptured
          - PaymentRefunded
          - OrderCreated
          - PaymentDisputed
        example: "PaymentCaptured"
      
      state_transition:
        type: object
        description: "Revenue state transition this event triggers"
        required:
          - from_state
          - to_state
        properties:
          from_state:
            type: string
            nullable: true
            description: "Starting state (null for initial state)"
            enum: [null, "authorized", "captured", "refunded", "chargeback"]
            example: "authorized"
          
          to_state:
            type: string
            description: "Target state after transition"
            enum: ["authorized", "captured", "refunded", "chargeback"]
            example: "captured"
          
          ledger_table:
            type: string
            description: "Table where transition is recorded"
            default: "revenue_state_transitions"
      
      idempotency:
        type: object
        description: "Idempotency rules for event processing"
        properties:
          key_field:
            type: string
            description: "Ledger column used for idempotency checking"
            example: "transaction_id"
          
          key_source:
            type: string
            description: "JSONPath to idempotency key in payload"
            example: "data.object.id"
          
          duplicate_handling:
            type: string
            enum: ["skip", "update_state", "quarantine"]
            description: "Action when duplicate detected"
            example: "skip"
      
      error_handling:
        type: object
        description: "Error handling strategy"
        properties:
          missing_required_field:
            type: string
            enum: ["quarantine", "reject", "log"]
            default: "quarantine"
          
          malformed_value:
            type: string
            enum: ["quarantine", "reject", "log"]
            default: "quarantine"
  
  validation_rules:
    - "canonical_event must exist in canonical-events.yaml"
    - "state_transition must match canonical event's implied transition"
    - "from_state and to_state must be valid revenue_ledger states"
  
  example:
    x-mapping:
      canonical_event: "PaymentCaptured"
      state_transition:
        from_state: "authorized"
        to_state: "captured"
        ledger_table: "revenue_state_transitions"
      idempotency:
        key_field: "transaction_id"
        key_source: "data.object.id"
        duplicate_handling: "skip"

# Extension: x-maps-to (property-level)
# Applied to: Schema properties (e.g., StripeChargeSucceededRequest.id)
# Purpose: Maps individual field to ledger column with transform
x-maps-to:
  description: "Property-level mapping extension for field-to-column mapping"
  location: "components.schemas.{SchemaName}.properties.{propertyName}"
  required_fields:
    - table
    - column
  optional_fields:
    - transform
    - required
  
  schema:
    type: object
    properties:
      table:
        type: string
        description: "Target ledger table"
        enum:
          - revenue_ledger
          - revenue_state_transitions
          - dead_events
        example: "revenue_ledger"
      
      column:
        type: string
        description: "Target column in ledger table"
        example: "transaction_id"
      
      transform:
        type: string
        description: "Transformation to apply during mapping"
        enum:
          - as-is
          - uppercase
          - lowercase
          - unix_to_timestamptz
          - iso8601_to_timestamptz
          - decimal_string_to_cents
          - int_to_string
          - prefix_provider
          - constant
        default: "as-is"
        example: "uppercase"
      
      transform_params:
        type: object
        description: "Parameters for transform (e.g., prefix, constant_value)"
        properties:
          prefix:
            type: string
            description: "Prefix for prefix_provider transform"
            example: "stripe_"
          
          constant_value:
            type: string
            description: "Value for constant transform"
            example: "stripe_webhook"
      
      required:
        type: boolean
        description: "Whether field is required for ledger write"
        default: false
        example: true
      
      notes:
        type: string
        description: "Human-readable mapping notes"
        example: "Stripe sends lowercase, ledger expects uppercase ISO 4217"
  
  validation_rules:
    - "table must exist in canonical_schema.yaml"
    - "column must exist in target table schema"
    - "transform must be valid transform type"
    - "transform_params must match transform type requirements"
  
  example:
    x-maps-to:
      table: "revenue_ledger"
      column: "currency"
      transform: "uppercase"
      required: true
      notes: "Stripe sends lowercase, ledger expects uppercase ISO 4217"

# Extension: x-validation-rules (schema-level)
# Applied to: Request/response schemas
# Purpose: Semantic validation rules beyond OpenAPI schema validation
x-validation-rules:
  description: "Schema-level semantic validation rules"
  location: "components.schemas.{SchemaName}"
  optional: true
  
  schema:
    type: array
    items:
      type: object
      properties:
        rule_id:
          type: string
          description: "Unique rule identifier"
          example: "currency_iso4217"
        
        rule_type:
          type: string
          enum: ["format", "business_logic", "cross_field", "external_reference"]
          example: "format"
        
        description:
          type: string
          example: "Currency must be valid ISO 4217 code"
        
        validation_expression:
          type: string
          description: "JSONPath or pseudo-code expression"
          example: "currency matches /^[A-Z]{3}$/"
        
        error_action:
          type: string
          enum: ["reject", "quarantine", "log"]
          default: "reject"
  
  example:
    x-validation-rules:
      - rule_id: "currency_iso4217"
        rule_type: "format"
        description: "Currency must be valid ISO 4217 code"
        validation_expression: "currency matches /^[A-Z]{3}$/"
        error_action: "reject"
      
      - rule_id: "amount_positive"
        rule_type: "business_logic"
        description: "Payment amount must be positive"
        validation_expression: "amount > 0"
        error_action: "reject"

# Usage Guidelines

usage_guidelines:
  when_to_use_x_mapping:
    - "Apply to all webhook request schemas that trigger revenue state transitions"
    - "Required for any schema mapped to revenue_ledger or revenue_state_transitions"
    - "Links schema to canonical event taxonomy (C0/C1)"
  
  when_to_use_x_maps_to:
    - "Apply to properties that map to ledger columns"
    - "Required for all critical revenue fields (transaction_id, amount_cents, currency, etc.)"
    - "Provides explicit transform specification for code generation"
  
  when_to_use_x_validation_rules:
    - "Optional semantic validations beyond JSON Schema"
    - "Use for business logic constraints (e.g., amount > 0)"
    - "Use for cross-field validations (e.g., refund_amount <= original_amount)"
  
  contract_generation_workflow:
    - "Define OpenAPI schema with standard JSON Schema validation"
    - "Add x-mapping at schema level to link to canonical event"
    - "Add x-maps-to to critical properties for field mapping"
    - "Optionally add x-validation-rules for semantic constraints"
    - "Run validate-x-mapping.py to ensure consistency with integration-maps/*.yaml"
    - "Generate Pydantic models with datamodel-codegen (extensions preserved as metadata)"
  
  validation_workflow:
    - "validate-x-mapping.py checks x-mapping presence for required schemas"
    - "Validates canonical_event exists in canonical-events.yaml"
    - "Validates state_transition matches canonical event"
    - "Validates x-maps-to references exist in canonical_schema.yaml"
    - "Validates consistency with integration-maps/*.yaml"

# Tooling Support

tooling_support:
  datamodel_codegen:
    version: ">=0.25.0"
    preserves_extensions: true
    notes: "x-* extensions preserved as __pydantic_extra__ in generated models"
  
  redocly_cli:
    version: ">=1.0.0"
    validates_extensions: false
    notes: "Custom extensions ignored during schema validation (as expected per OpenAPI spec)"
  
  openapi_generator:
    version: ">=7.0.0"
    preserves_extensions: true
    notes: "Extensions available in template context for custom generators"

# Versioning

versioning:
  current_version: "1.0.0"
  changelog:
    - version: "1.0.0"
      date: "2024-01-15"
      changes:
        - "Initial x-mapping schema definition"
        - "Added x-maps-to for property-level mapping"
        - "Added x-validation-rules for semantic constraints"
  
  backward_compatibility:
    - "Adding new optional fields to extensions: BACKWARD COMPATIBLE"
    - "Adding new enum values to transform types: BACKWARD COMPATIBLE"
    - "Removing enum values or required fields: BREAKING CHANGE"
    - "Renaming extension properties: BREAKING CHANGE"



