{
  "contract_id": "b07.llm_api_calls.write_contract",
  "contract_version": "1.0.0",
  "owner": "llm",
  "purpose": "Machine-checkable write-shape obligations for B0.7 LLM persistence. This is a forward contract (some fields are not yet implemented).",
  "targets": [
    {
      "schema": "public",
      "table": "llm_api_calls",
      "tenant_scoped": true
    }
  ],
  "b07_target_row_shape": {
    "required_columns": [
      {
        "name": "tenant_id",
        "type": "uuid",
        "nullable": false,
        "notes": "Tenant boundary for RLS."
      },
      {
        "name": "user_id",
        "type": "uuid",
        "nullable": false,
        "notes": "User boundary for per-user monthly caps (B0.7 invariant)."
      },
      {
        "name": "created_at",
        "type": "timestamptz",
        "nullable": false,
        "notes": "Write timestamp (source of truth for rollups)."
      },
      {
        "name": "endpoint",
        "type": "text",
        "nullable": false,
        "notes": "Logical callsite (task/route) for attribution and audit."
      },
      {
        "name": "request_id",
        "type": "text",
        "nullable": false,
        "notes": "Idempotency key; must be unique within (tenant_id, endpoint)."
      },
      {
        "name": "provider",
        "type": "text",
        "nullable": false,
        "notes": "Provider label (normalized by aisuite via Skeldir provider boundary)."
      },
      {
        "name": "model",
        "type": "text",
        "nullable": false,
        "notes": "Resolved model label (post-policy)."
      },
      {
        "name": "input_tokens",
        "type": "int",
        "nullable": false,
        "constraints": [
          ">=0"
        ]
      },
      {
        "name": "output_tokens",
        "type": "int",
        "nullable": false,
        "constraints": [
          ">=0"
        ]
      },
      {
        "name": "cost_cents",
        "type": "int",
        "nullable": false,
        "constraints": [
          ">=0"
        ],
        "notes": "Monetary values must be stored as integer cents."
      },
      {
        "name": "latency_ms",
        "type": "int",
        "nullable": false,
        "constraints": [
          ">=0"
        ]
      },
      {
        "name": "was_cached",
        "type": "bool",
        "nullable": false,
        "notes": "True when semantic cache served response without provider dispatch."
      },
      {
        "name": "distillation_eligible",
        "type": "bool",
        "nullable": false,
        "notes": "Explicit training-signal eligibility gate (must not be inferred)."
      },
      {
        "name": "request_metadata_ref",
        "type": "jsonb_ref",
        "nullable": true,
        "notes": "Pointer/reference to request metadata (separate from training signal)."
      },
      {
        "name": "response_metadata_ref",
        "type": "jsonb_ref",
        "nullable": true,
        "notes": "Pointer/reference to response metadata (operational telemetry)."
      },
      {
        "name": "reasoning_trace_ref",
        "type": "jsonb_ref",
        "nullable": true,
        "notes": "Pointer/reference to reasoning trace where available; must be demarcated from user output."
      }
    ],
    "required_uniques": [
      [
        "tenant_id",
        "request_id",
        "endpoint"
      ]
    ]
  }
}

