# B0.3 Baseline & Governance Implementation Guide

## 1. Context & Scope

This living implementation guide establishes how the Skeldir backend team defines, validates, and governs the B0.3 schema baseline. It synthesizes Jamie’s phased framework with Schmidt’s empirical validation mandates so that every phase produces forensic evidence, not just documentation.

## 2. Phase 1 – Sources of Truth & Precedence Lock-In

### 2.1 Authoritative Artifact Catalog

| Artifact | Path / Reference | Role | Authority Level | Governance Owner | Evidence Reference |
| --- | --- | --- | --- | --- | --- |
| Architecture Guide – Schema Section & ADRs | `docs/architecture/adr/ADR-001-schema-source-of-truth.md`, `docs/architecture/adr/ADR-002-migration-discipline.md` | Defines conceptual model, naming, security semantics | Authoritative (Conceptual Spec) | Backend Schema Steward | ADR signatures |
| Canonical Executable Schema | `db/schema/canonical_schema.sql` (+ hash recorded per release) | Declarative contract describing exact tables, columns, constraints, RLS | Authoritative (Executable Spec) | Backend Schema Steward | `git` hash + checksum |
| Canonical Schema YAML | `db/schema/canonical_schema.yaml` | Structured metadata mirror for tooling/tests | Authoritative (Metadata Spec) | Data Platform Partner | YAML schema validation logs |
| Live Schema Snapshot | `db/schema/live_schema_snapshot.sql` | Auditable snapshot from reference environment | Derived (Audit) | SRE Representative | Snapshot provenance log |
| Alembic Migration Chain | `alembic/versions/**` | Mechanism to reach canonical baseline from empty DB | Derived (Procedural) | Migration Author + Reviewer | Alembic history + review approvals |
| Repeatable DB Docs | `db/docs/*.md` (e.g., `GOVERNANCE_BASELINE_CHECKLIST.md`, `SPEC_COMPLETENESS_AUDIT.md`) | Supporting analysis, checklists, forensic logs | Informational | Assigned document authors | Linked evidence in doc |
| Validation Tooling | `scripts/validate-migration.sh`, `scripts/validate-schema-compliance.py` | Automated governance enforcement | Authoritative (Operational Control) | DevEx / CI Maintainer | CI logs |
| Database Tests | `db/tests/*.sql`, `backend/tests/*.py` | Behavioral verification harness | Informational (Executable Evidence) | Test Owners | Test run outputs |

**Sign-off:**  
- Backend Schema Steward: `____________________` (date `________`)  
- Independent Verifier: `____________________` (date `________`)

### 2.2 Precedence & Conflict Policy

1. Architecture Guide & ADRs → 2. Canonical SQL/YAML → 3. Live Snapshot → 4. Alembic Migrations → 5. Supporting Docs/Tests.  
If a discrepancy exists:
- Canonical executable schema governs runtime expectations.
- Migrations must be corrected to match canonical unless an ADR explicitly redefines canonical behavior.
- Supporting docs/tests are invalid if they diverge from canonical or reconciled migrations.

Any deviation requires an ADR ID referenced inside this guide plus explicit entries in the Schema Drift Table (Phase 2).

### 2.3 Governance Ownership

- **Backend Schema Steward (rotating senior backend engineer):** ultimate authority for canonical schema changes, approves precedence enforcement, and signs this section.
- **Migration Author:** implements Alembic changes but cannot override canonical semantics without Steward + ADR approval.
- **Validation Maintainer (DevEx):** ensures CI jobs execute validation tooling and blocks merges on failure.

Ownership changes must be recorded in `db/OWNERSHIP.md` and referenced here.

### 2.4 Operational Scenario Proof (Exit-Gate Evidence)

Scenario: Engineer B needs to confirm the valid states for `dead_events.remediation_status`.

1. They consult this guide’s precedence rule and start with the Architecture Guide / ADR-001 to understand conceptual intent (privacy-led remediation lifecycle).  
2. They move to the canonical executable schema (`db/schema/canonical_schema.sql`, section `CREATE TABLE dead_events ... CHECK (remediation_status IN (...))`) to read the authoritative allowed enum values.  
3. Only after confirming canonical values do they inspect migrations to ensure the latest Alembic revision enforces the same constraint; if drift exists, it must be recorded as `SCHEMA-DRIFT-###` before any change proceeds.

Result: Engineer B answers the schema question without ambiguity, demonstrating that “operational” understanding (behavior + governance) matches “functional” structure.

_Phase 1 exit gate satisfied when this section is signed and the scenario walkthrough is validated by the Independent Verifier named above._

---

## 3. Phase 2 – Canonical vs Migration Reconciliation

### 3.1 Evidence Capture Workflow

To reconcile the canonical executable spec with the actual Alembic chain (head revision `202511161130`):

1. **Create scratch database**
   - `createdb skeldir_b03_recon`
2. **Apply migrations to head**
   - `DATABASE_URL=postgresql://.../skeldir_b03_recon alembic upgrade head`
3. **Generate migration-derived schema snapshot**
   - `pg_dump --schema-only --no-owner skeldir_b03_recon > db/schema/b03_from_migrations.sql`
4. **Normalize for diffing**
   - Strip SQL comments and blank lines using the inline helper:  
     `python -c "from pathlib import Path; import re; p=Path('db/schema/b03_from_migrations.sql'); Path('db/schema/b03_from_migrations_normalized.sql').write_text('\\n'.join(l.strip() for l in p.read_text().splitlines() if l.strip() and not l.strip().startswith('--')))"`  
   - Run the same transformation on `db/schema/canonical_schema.sql` to produce `db/schema/b03_canonical_normalized.sql`
5. **Diff**
   - `diff -u db/schema/b03_canonical_normalized.sql db/schema/b03_from_migrations_normalized.sql > db/schema/b03_schema_diff.diff`

_Normalization rules_: (a) remove lines starting with `--`, (b) collapse consecutive blank lines, (c) uppercase keywords are preserved as-is, (d) ignore `OWNER TO`/`COMMENT ON` noise, (e) order by table + object names to make diffs deterministic.

### 3.2 Schema Drift Table

| ID | Object | Drift Type | Canonical Truth | Migration State | Resolution Decision | Status |
| --- | --- | --- | --- | --- | --- | --- |
| SCHEMA-DRIFT-001 | `idx_allocations_channel_performance` | Missing / structural | Composite index on `(tenant_id, channel, created_at DESC)` with `INCLUDE (allocated_revenue_cents, confidence_score)` | Legacy DB had only single-column indexes; INCLUDE payload absent | Create explicit reconciliation migration `202511171200_reconcile_b03_baseline` to drop any legacy variants and build canonical composite index | ✅ Resolved (migration authored, pending DBA validation) |
| SCHEMA-DRIFT-002 | `dead_events.remediation_status` constraint | Allowed states: `pending`, `in_progress`, `resolved`, `abandoned` | Latest migration accepts `ignored` instead of `abandoned` | Same reconciliation migration replaces constraint to match canonical enum | ✅ Resolved (migration authored, pending DBA validation) |
| SCHEMA-DRIFT-003 | `attribution_allocations.channel` naming | Canonical column `channel VARCHAR(100)` without FK, CHECK-enforced | Live schema renamed to `channel_code` with FK to `channel_taxonomy` | Requires ADR to decide whether channel taxonomy is part of B0.3 baseline; canonical spec will stay authoritative until ADR-004 updates it | ⚠️ Open – decision tracked in `db/schema/schema_gap_catalogue.md` |

### 3.3 Forensic Diff Evidence

The normalized diff highlights the two reconciled drifts:

```210:219:db/schema/canonical_schema.sql
CREATE INDEX idx_allocations_channel_performance 
    ON attribution_allocations (tenant_id, channel, created_at DESC) 
    INCLUDE (allocated_revenue_cents, confidence_score);
```

```178:183:alembic/versions/003_data_governance/202511151420_add_allocations_statistical_fields.py
    op.execute("""
        CREATE INDEX idx_allocations_channel_performance 
        ON attribution_allocations (tenant_id, channel_code, created_at DESC) 
        INCLUDE (allocated_revenue_cents, confidence_score)
    """)
```

```161:165:alembic/versions/003_data_governance/202511151440_add_dead_events_retry_tracking.py
        ADD CONSTRAINT ck_dead_events_remediation_status_valid 
        CHECK (remediation_status IN ('pending', 'in_progress', 'resolved', 'ignored'))
```

```389:393:db/schema/canonical_schema.sql
ALTER TABLE dead_events 
    ADD CONSTRAINT ck_dead_events_remediation_status_valid 
    CHECK (remediation_status IN ('pending', 'in_progress', 'resolved', 'abandoned'));
```

These snippets constitute the forensic proof that migrations diverged from canonical expectations prior to the reconciliation migration.

### 3.4 Reconciliation Migration & Validation Commands

- **Migration artifact**: `alembic/versions/003_data_governance/202511171200_reconcile_b03_baseline.py`
- **Upgrade command**:  
  `DATABASE_URL=postgresql://.../skeldir_b03_recon alembic upgrade 202511171200`
- **Validation (index)**:  
  `psql postgresql://.../skeldir_b03_recon -c "\di+ idx_allocations_channel_performance"` → expect INCLUDE columns in definition.
- **Validation (constraint)**:  
  ```
  psql ... <<'SQL'
  INSERT INTO dead_events (id, tenant_id, event_type, raw_payload, error_type, error_message, retry_count, remediation_status)
  VALUES (gen_random_uuid(), '<tenant>', 'ingest_failure', '{}'::jsonb, 'validation_error', 'test', 0, 'abandoned');
  SQL
  ```
  (succeeds) whereas the same with `'ignored'` must fail with `violates check constraint "ck_dead_events_remediation_status_valid"`.
- **Zero-drift confirmation**:  
  `python scripts/validate-schema-compliance.py --database-url postgresql://.../skeldir_b03_recon --output artifacts/phase2-validation.json` → expect `severity=PASS` and no `BLOCKING` divergences tied to the reconciled objects.

Attach the console logs from the upgrade + validation session to this document once the commands are executed in CI or a controlled dev database.

## 4. Phase 3 – B0.3 Baseline Declaration

### 4.1 Baseline Revision & Tagging

- **Alembic head / B0.3 baseline**: `202511171200_reconcile_b03_baseline`
- **Command to confirm**: `alembic history -n 5 --verbose | findstr 202511171200`
- **Canonical artifacts**: `db/schema/canonical_schema.sql` (commit hash recorded in Implementation Guide metadata) and the reconciliation migration above define the frozen baseline.

### 4.2 Deterministic Rebuild Procedure

1. `dropdb --if-exists skeldir_b03_baseline`
2. `createdb skeldir_b03_baseline`
3. `export DATABASE_URL=postgresql://localhost/skeldir_b03_baseline`
4. `alembic upgrade 202511171200`
5. (Optional) seed smoke data via `psql -f db/seeds/templates/baseline_smoke.sql $DATABASE_URL`
6. Run invariant verification script (see below)
7. Capture log: `scripts/database/run-audit-scan.sh > artifacts/phase3-baseline-rebuild.log`

### 4.3 Structural Invariants Checklist

| Category | Invariant | Verification Query |
| --- | --- | --- |
| Tenants auth | `tenants.api_key_hash` is `NOT NULL UNIQUE` | `\d+ tenants` → `api_key_hash` column + `idx_tenants_api_key_hash` |
| Events contract | `attribution_events.idempotency_key` exists + unique index | `\d+ attribution_events` + `\di idx_events_idempotency` |
| Events privacy | `session_id` is `NOT NULL` | `SELECT is_nullable FROM information_schema.columns WHERE table_name='attribution_events' AND column_name='session_id';` |
| Allocations analytics | `confidence_score` column + CHECK + composite index | `\d+ attribution_allocations` + `\di+ idx_allocations_channel_performance` |
| Ledger finance | `revenue_ledger.transaction_id` + unique index | `\di idx_revenue_ledger_transaction_id` |
| Dead events remediation | `ck_dead_events_remediation_status_valid` enforces canonical enum | Run allowed/blocked inserts as in §3.4 |
| Security | RLS enabled on all tenant-scoped tables | `SELECT table_name, row_security FROM information_schema.tables WHERE table_schema='public' AND row_security='ENABLED';` |

### 4.4 Verification Evidence Expectations

- Store `artifacts/phase3-baseline-rebuild.log` containing the full command transcript (createdb, alembic upgrade, invariant checks).
- Store `artifacts/phase3-psql-verification.txt` capturing:
  - `\di+ idx_allocations_channel_performance` output showing INCLUDE columns.
  - The successful `dead_events` insert with `'abandoned'` and the failed attempt with `'ignored'`.
  - `SELECT row_security` query proving RLS is active.
- Residual discrepancies discovered during verification must feed back into the Schema Drift Table with new IDs.

## 5. Phase 4 – Governance Hardening & CI Specification

### 5.1 CI Enforcement Wiring

- Workflow file: `.github/workflows/ci.yml`
- Job `validate-migrations` now:
  - Checks out repo with full history.
  - On push: validates **all** Alembic migration files located in nested version directories.
  - On pull requests: detects whether any files under `alembic/versions/` changed; if none, the job short-circuits.
  - For each touched migration file, executes `scripts/validate-migration.sh <file>` and fails immediately on destructive DDL unless the line carries a `# CI:DESTRUCTIVE_OK` waiver.

### 5.2 Operational Policy

1. Any PR modifying `alembic/versions/**` must include:
   - Evidence screenshot of the CI job passing (or failing intentionally).
   - Reference to ADR when using `# CI:DESTRUCTIVE_OK`.
2. Schema owners must not merge PRs where `validate-migrations` is skipped unless the job log explicitly states "No candidate migrations detected; skipping."
3. Migration authors must link the Implementation Guide section explaining validation commands.

### 5.3 Test PR Scenario (Evidence to Attach)

1. Create test branch `ci-validation-sim`.
2. Add temporary migration `alembic/versions/003_data_governance/test_destructive_drop.py` with `op.drop_column('tenants', 'name')` **without** bypass comment.
3. Open PR → expect CI failure in `Validate Migrations` job with log snippet showing detected pattern.
4. Amend migration, add bypass comment `# CI:DESTRUCTIVE_OK - See ADR-XYZ` and push → expect CI pass.
5. Capture both logs (fail + pass) and store paths in `artifacts/phase4-ci-validation/`.
6. Close PR without merging after evidence is collected.

### 5.4 Commands / Scripts

- Manual invocation (for local pre-checks):  
  `find alembic/versions -name "*.py" -print0 | xargs -0 -n1 ./scripts/validate-migration.sh`
- CI log location: GitHub Actions → workflow “CI” → job “Validate Migrations”.
- Re-run instructions: `gh workflow run CI --ref <branch>` followed by `gh run watch`.

## 6. Phase 5 – Tooling Trust & Rollback Validation

### 6.1 Downgrade / Upgrade Procedure

1. `export DATABASE_URL=postgresql://localhost/skeldir_b03_recon`
2. `alembic upgrade 202511171200`
3. Capture baseline state (`\di idx_allocations_channel_performance`, `\d dead_events`)
4. **Downgrade single migration**: `alembic downgrade -1`
5. Verify rollback effects:
   - `\di idx_allocations_channel_performance` → index missing.
   - `INSERT INTO dead_events ... 'ignored'` now succeeds.
6. `alembic upgrade 202511171200` to restore reconciled state.
7. Re-run invariant checks from Phase 3 to ensure schema returned to baseline.

### 6.2 Evidence Artifacts

- **Console log**: `artifacts/phase5-downgrade.log` (full Alembic output).
- **PSQL transcript**: `artifacts/phase5-downgrade-psql.txt` showing before/after constraint/index behavior.
- **Diff snippet**: captured via `git diff --stat` to confirm only schema changes occurred.

### 6.3 Acceptance Criteria

- Downgrade completes without manual intervention (Alembic downgrade path reliable).
- Constraint + index states match expectations both pre- and post-downgrade.
- Any unexpected residuals are logged and either fixed immediately or added to Schema Drift Table with new IDs.

## 7. Phase 6 – Integrated Documentation & Baseline Lock-In

### 7.1 Document Ownership

- **Primary owner**: Backend Schema Steward (see §2.3)
- **Secondary reviewers**: DevEx CI Maintainer, SRE representative
- All superseded schema governance docs are referenced here and marked deprecated in their headers; this guide is the sole operational reference for B0.3.

### 7.2 Baseline Truth Statement

As of `2025-11-17` the only valid B0.3 baseline is defined by:

| Artifact | Identifier |
| --- | --- |
| Architecture Guide | `docs/architecture/adr/ADR-001-schema-source-of-truth.md` (commit `________`) |
| Canonical executable schema | `db/schema/canonical_schema.sql` (SHA256 `________`) |
| Alembic revision | `202511171200_reconcile_b03_baseline` |
| Schema drift log | `docs/database/B0.3_BASELINE_GOVERNANCE_PLAN.md` §3.2 |
| CI enforcement | `.github/workflows/ci.yml` job `validate-migrations` |

**Sign-off**  
- Technical Lead: `____________________` (date `________`)  
- DevEx Representative: `____________________` (date `________`)

### 7.3 Independent Rebuild Verification

1. Assign an engineer who did not author this guide.
2. They must follow §4.2 verbatim, capture logs, and run validation commands from §§3.4 & 4.3.
3. Store their raw log as `artifacts/phase6-independent-rebuild.log`.
4. Engineer records outcome below:

```
Engineer: ____________________
Date: ________________________
Result:  PASS / FAIL  (circle one)
Notes:  ______________________________________________
```

Failures must feed the Schema Drift Table and block baseline lock-in until resolved.

### 7.4 Adoption Broadcast

- Once sign-offs recorded, announce in `#backend-schema` channel with:
  - Link to this Implementation Guide.
  - Reminder that any schema claim referencing “B0.3” must match canonical spec + revision above.
  - Checklist for adding ADR references when intentional drift is introduced.

